<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>授权 OAuth 应用 | 开发者文档</title>
    <meta name="description" content="语雀开发者文档中心">
    <meta name="referrer" content="no-referrer">
    
    <link rel="preload" href="/assets/css/0.styles.ee743eda.css" as="style"><link rel="preload" href="/assets/js/app.dc7065eb.js" as="script"><link rel="preload" href="/assets/js/2.aebe52ac.js" as="script"><link rel="preload" href="/assets/js/16.8b34ccdc.js" as="script"><link rel="prefetch" href="/assets/js/10.fccf2a4b.js"><link rel="prefetch" href="/assets/js/11.b9fa8164.js"><link rel="prefetch" href="/assets/js/12.c0e913c0.js"><link rel="prefetch" href="/assets/js/13.1d394feb.js"><link rel="prefetch" href="/assets/js/14.e1d90071.js"><link rel="prefetch" href="/assets/js/15.7c9f99b3.js"><link rel="prefetch" href="/assets/js/17.5eb043b8.js"><link rel="prefetch" href="/assets/js/18.9a12ddcc.js"><link rel="prefetch" href="/assets/js/19.0054b858.js"><link rel="prefetch" href="/assets/js/20.8bb92eb4.js"><link rel="prefetch" href="/assets/js/21.bfab265e.js"><link rel="prefetch" href="/assets/js/22.3f4d40c4.js"><link rel="prefetch" href="/assets/js/23.a3def4fb.js"><link rel="prefetch" href="/assets/js/24.a4de4fa2.js"><link rel="prefetch" href="/assets/js/25.5880bb97.js"><link rel="prefetch" href="/assets/js/26.e4143023.js"><link rel="prefetch" href="/assets/js/27.d24bc1b3.js"><link rel="prefetch" href="/assets/js/28.cab2a78c.js"><link rel="prefetch" href="/assets/js/3.01e39e86.js"><link rel="prefetch" href="/assets/js/4.3e6868fb.js"><link rel="prefetch" href="/assets/js/5.f0b6bd0e.js"><link rel="prefetch" href="/assets/js/6.addb8860.js"><link rel="prefetch" href="/assets/js/7.be3f6e8f.js"><link rel="prefetch" href="/assets/js/8.7d3f8fcb.js"><link rel="prefetch" href="/assets/js/9.631e3d5f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ee743eda.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">开发者文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>API</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/api.html" class="sidebar-link">Overview</a></li><li><a href="/user.html" class="sidebar-link">User - 用户</a></li><li><a href="/group.html" class="sidebar-link">Group - 组织</a></li><li><a href="/repo.html" class="sidebar-link">Repo - 仓库</a></li><li><a href="/doc.html" class="sidebar-link">Doc - 文档</a></li><li><a href="/high_level_api.html" class="sidebar-link">高级接口</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>OAuth</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/about-oauth-apps.html" class="sidebar-link">关于 OAuth 应用</a></li><li><a href="/create-oauth-apps.html" class="sidebar-link">创建 OAuth 应用</a></li><li><a href="/authorizing-oauth-apps.html" class="active sidebar-link">授权 OAuth 应用</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/understanding-scopes-for-oauth-apps.html" class="sidebar-link">了解 OAuth 应用的授权范围</a></li><li><a href="/reset-oauth-client-secret.html" class="sidebar-link">重置 OAuth 应用密钥</a></li><li><a href="/delete-oauth-apps.html" class="sidebar-link">删除 OAuth 应用</a></li></ul></section></li><li><a href="/doc-webhook.html" class="sidebar-link">Webhooks</a></li><li><a href="/xg7leo.html" class="sidebar-link">社区工具</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Response Serializers</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/userserializer.html" class="sidebar-link">UserSerializer</a></li><li><a href="/userdetailserializer.html" class="sidebar-link">UserDetailSerializer</a></li><li><a href="/bookserializer.html" class="sidebar-link">BookSerializer</a></li><li><a href="/bookdetailserializer.html" class="sidebar-link">BookDetailSerializer</a></li><li><a href="/docserializer.html" class="sidebar-link">DocSerializer</a></li><li><a href="/docdetailserializer.html" class="sidebar-link">DocDetailSerializer</a></li><li><a href="/docversionserializer.html" class="sidebar-link">DocVersionSerializer</a></li><li><a href="/docversiondetailserializer.html" class="sidebar-link">DocVersionDetailSerializer</a></li><li><a href="/groupuserserializer.html" class="sidebar-link">GroupUserSerializer</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="授权-oauth-应用"><a href="#授权-oauth-应用" class="header-anchor">#</a> 授权 OAuth 应用</h1> <p><span>语雀支持标准的 </span><a href="https://oauth.net/2/grant-types/authorization-code/" target="_blank">OAuth2 authorization code</a> 授权模式</p> <h3 id="web-应用流程"><a href="#web-应用流程" class="header-anchor">#</a> Web 应用流程</h3> <h4 id="流程"><a href="#流程" class="header-anchor">#</a> 流程</h4> <ol start="1"><li>用户被重定向以请求他们的语雀身份</li><li>用户被语雀重定向回你的网站</li><li>你的应用使用用户的 access token 访问 API</li></ol> <h4 id="时序图"><a href="#时序图" class="header-anchor">#</a> 时序图</h4> <img src="https://cdn.nlark.com/yuque/__puml/ffdb2a50598745d519649c604ed53bd6.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbmF1dG9udW1iZXJcblxuYWN0b3IgXCLnlKjmiLdcIiBhcyBVc2VyXG5wYXJ0aWNpcGFudCBcIuW6lOeUqOWuouaIt-err1wiIGFzIEFwcENsaWVudFxucGFydGljaXBhbnQgXCLlupTnlKjmnI3liqHnq69cIiBhcyBBcHBTZXJ2ZXJcbnBhcnRpY2lwYW50IFwi6K-t6ZuA5o6I5p2D5pyN5YqhXCIgYXMgQXV0aFNlcnZlciAjb3JhbmdlXG5wYXJ0aWNpcGFudCBcIuivrembgOi1hOa6kOacjeWKoVwiIGFzIFJlc291cmNlU2VydmVyICNvcmFuZ2VcblxuYWN0aXZhdGUgVXNlclxuXG5Vc2VyIC0-IEFwcENsaWVudDog55So5oi36K6_6Zeu5bqU55SoXG5hY3RpdmF0ZSBBcHBDbGllbnRcbkFwcENsaWVudCAtPiBBcHBDbGllbnQ6IOmAieaLqeivrembgOeZu-W9lVxuXG5BcHBDbGllbnQgLT4gQXV0aFNlcnZlcjog5bCG55So5oi36YeN5a6a5ZCR5Yiw5o6I5p2D6aG1IEdFVCBodHRwczovL3d3dy55dXF1ZS5jb20vb2F1dGgyL2F1dGhvcml6ZVxubm90ZSByaWdodCBvZiBBcHBDbGllbnQ6IOW4puS4iiBjbGllbnRfaWTjgIFzY29wZeOAgXJlZGlyZWN0X3VyaeOAgXN0YXRl44CBcmVzcG9uc2VfdHlwZSDlj4LmlbBcbmFjdGl2YXRlIEF1dGhTZXJ2ZXJcblxuQXV0aFNlcnZlciAtPiBBdXRoU2VydmVyOiDmjojmnYPmiJDlip_lkI7lsIbkvJrph43lrprlkJHliLDmjIflrprnmoTlm57osIPlnLDlnYBcbm5vdGUgcmlnaHQgb2YgQXV0aFNlcnZlcjog5Lmf5bCx5piv6K-35rGC5bim5LiK55qEIHJlZGlyZWN0X3VyaSwg6YeN5a6a5ZCR5LiA6Iis5piv5bqU55So5pyN5Yqh56uv5o6l5Y-jXG5cbkF1dGhTZXJ2ZXIgLT4gQXBwU2VydmVyOiDph43lrprlkJHlm57osIPvvIzov5Tlm54gc3RhdGUg5ZKMIGNvZGUgXG5hY3RpdmF0ZSBBcHBTZXJ2ZXJcblxuQXBwU2VydmVyIC0-IEF1dGhTZXJ2ZXI6IOmAmui_hyBjb2RlIOaNouWPlueUqOaItyB0b2tlbiBQT1NUIGh0dHBzOi8vd3d3Lnl1cXVlLmNvbS9vYXV0aDIvdG9rZW5cbm5vdGUgcmlnaHQgb2YgQXBwU2VydmVyOiDov5nph4zpnIDopoHluKbkuIogY2xpZW50X2lk44CBY2xpZW50X3NlY3JldOOAgWNvZGXjgIFncmFudF90eXBlXG5cblxuQXV0aFNlcnZlciAtPiBBcHBTZXJ2ZXI6IOi_lOWbnueUqOaItyB0b2tlbiDkv6Hmga9cbm5vdGUgcmlnaHQgb2YgQXBwU2VydmVyOiDljIXlkKsgYWNjZXNzX3Rva2Vu44CBdG9rZW5fdHlwZeOAgXNjb3BlXG5kZWFjdGl2YXRlIEF1dGhTZXJ2ZXJcblxuQXBwU2VydmVyIC0-IEFwcENsaWVudDog6L-U5Zue5o6I5p2D5oiQ5YqfXG5kZWFjdGl2YXRlIEFwcFNlcnZlclxuQXBwQ2xpZW50IC0-IFJlc291cmNlU2VydmVyOiDlrqLmiLfnq6_lj5HotbfnlKjmiLfln7rmnKzkv6Hmga_otYTmupDor7fmsYIgY3VybCAtSCAnWC1BdXRoLVRva2VuOiAke3Rva2VufScgaHR0cHM6Ly9sYXJrLmFsaXBheS5jb20vYXBpL3YyL3VzZXJcbmFjdGl2YXRlIFJlc291cmNlU2VydmVyXG5SZXNvdXJjZVNlcnZlciAtPiBBcHBDbGllbnQ6IOi_lOWbnueUqOaIt-S_oeaBr1xuZGVhY3RpdmF0ZSBSZXNvdXJjZVNlcnZlclxuQXBwQ2xpZW50IC0-IFVzZXI6IOWIt-aWsOmhtemdou-8jOaYvuekuueUqOaIt-S_oeaBr1xuXG5Vc2VyIC0-IEFwcENsaWVudDog55So5oi35Y-R6LW36K-35rGC6K-t6ZuA6LWE5rqQ55qE5Yqo5L2cXG5BcHBDbGllbnQgLT4gUmVzb3VyY2VTZXJ2ZXI6IOWuouaIt-err-WPkei1t-i1hOa6kOivt-axglxuYWN0aXZhdGUgUmVzb3VyY2VTZXJ2ZXJcblJlc291cmNlU2VydmVyIC0-IEFwcENsaWVudDog6L-U5Zue6LWE5rqQXG5kZWFjdGl2YXRlIFJlc291cmNlU2VydmVyXG5BcHBDbGllbnQgLT4gVXNlcjog5pi-56S66LWE5rqQXG5cbkBlbmR1bWwiLCJ1cmwiOiJodHRwczovL2Nkbi5ubGFyay5jb20veXVxdWUvX19wdW1sL2ZmZGIyYTUwNTk4NzQ1ZDUxOTY0OWM2MDRlZDUzYmQ2LnN2ZyIsInR5cGUiOiJwdW1sIiwiaWQiOiJjcTR3MSIsImNhcmQiOiJkaWFncmFtIn0=" style="max-width:600px;"> <h4 id="_1-将用户重定向到语雀授权页"><a href="#_1-将用户重定向到语雀授权页" class="header-anchor">#</a> 1. 将用户重定向到语雀授权页</h4> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token constant">GET</span> https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>yuque<span class="token punctuation">.</span>com<span class="token operator">/</span>oauth2<span class="token operator">/</span>authorize 
</code></pre></div><h5 id="参数"><a href="#参数" class="header-anchor">#</a> 参数</h5> <table class="lake-table"><colgroup><col width="161"><col width="93"><col width="460"></colgroup><tbody><tr><td><p>参数名</p></td><td><p>类型</p></td><td><p>描述</p></td></tr><tr><td><p><code>client_id</code></p></td><td><p><code>string</code></p></td><td><p>语雀应用分配的 client_id</p></td></tr><tr><td><p><code>scope</code></p></td><td><p><code>string</code></p></td><td><p>要求用户授权的 <a href="https://www.yuque.com/yuque/developer/understanding-scopes-for-oauth-apps#opr4j" target="_blank">权限范围</a>，多个权限用逗号分隔，例如: <code>doc,repo,group:read</code></p></td></tr><tr><td><p><code>redirect_uri</code></p></td><td><p><code>string</code></p></td><td><p>重定向地址，授权完成后会跳转到这个路径，并带上临时授权 code</p></td></tr><tr><td><p><code>state</code></p></td><td><p><code>string</code></p></td><td><p>OAuth 规范中的 state，会透传到回调的 redirect_uri 参数</p></td></tr><tr><td><p><code>response_type</code></p></td><td><p><code>string</code></p></td><td><p>固定值: <code>code</code></p></td></tr></tbody></table> <h4 id="_2-用户被重定向回应用回调地址"><a href="#_2-用户被重定向回应用回调地址" class="header-anchor">#</a> 2. 用户被重定向回应用回调地址</h4> <p>用户确认授权后，将被重定向到应用指定的回调地址，并附带 <code>state</code> 和 <code>code</code> 参数。</p> <h5 id="参数-2"><a href="#参数-2" class="header-anchor">#</a> 参数</h5> <table class="lake-table"><colgroup><col width="170"><col width="94"><col width="454"></colgroup><tbody><tr><td><p>参数名</p></td><td><p>类型</p></td><td><p>描述</p></td></tr><tr><td><p><code>code</code></p></td><td><p><code>string</code></p></td><td><p>用户的临时授权码，用于后续流程中调用语雀接口，换取用户的 access_token</p></td></tr><tr><td><p><code>state</code></p></td><td><p><code>string</code></p></td><td><p>上一步流程中的 state 参数透传</p></td></tr></tbody></table> <h4 id="_3-通过-code-换取用户-token"><a href="#_3-通过-code-换取用户-token" class="header-anchor">#</a> 3. 通过 code 换取用户 token</h4> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token constant">POST</span> https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>yuque<span class="token punctuation">.</span>com<span class="token operator">/</span>oauth2<span class="token operator">/</span>token 
</code></pre></div><h5 id="参数-3"><a href="#参数-3" class="header-anchor">#</a> 参数</h5> <table class="lake-table"><colgroup><col width="181"><col width="99"><col width="435"></colgroup><tbody><tr><td><p>参数名</p></td><td><p>类型</p></td><td><p>描述</p></td></tr><tr><td><p><code>client_id</code></p></td><td><p><code>string</code></p></td><td><p>语雀应用分配的 client_id</p></td></tr><tr><td><p><code>client_secret</code></p></td><td><p><code>string</code></p></td><td><p>语雀应用分配的 client_secret</p></td></tr><tr><td><p><code>code</code></p></td><td><p><code>string</code></p></td><td><p>前序流程中获取到的临时授权码</p></td></tr><tr><td><p><code>grant_type</code></p></td><td><p><code>string</code></p></td><td><p>固定值 <code>authorization_code</code></p></td></tr></tbody></table> <h5 id="响应"><a href="#响应" class="header-anchor">#</a> 响应</h5> <p>响应是一个 JSON 格式的字符串，包含用户授权后的 token，该 token 只能访问用户授权范围内的 API。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">{</span> 
 <span class="token string">&quot;access_token&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;am9ic0B5dXF1ZS5jb20=&quot;</span><span class="token punctuation">,</span>
 <span class="token string">&quot;token_type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;bearer&quot;</span><span class="token punctuation">,</span>
 <span class="token string">&quot;scope&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;repo,doc&quot;</span>
<span class="token punctuation">}</span> 
</code></pre></div><h4 id="_4-通过-token-来访问语雀的-api"><a href="#_4-通过-token-来访问语雀的-api" class="header-anchor">#</a> 4. 通过 token 来访问语雀的 API</h4> <div class="language-ruby extra-class"><pre class="language-ruby"><code>curl <span class="token operator">-</span><span class="token constant">H</span> <span class="token string">'X-Auth-Token: ${token}'</span> https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>yuque<span class="token punctuation">.</span>com<span class="token operator">/</span>api<span class="token operator">/</span>v2<span class="token operator">/</span>user 
</code></pre></div><h3 id="非-web-应用流程"><a href="#非-web-应用流程" class="header-anchor">#</a> 非 Web 应用流程</h3> <p>有些应用可能并没有服务端支持，而是一个纯客户端应用（浏览器插件、命令行工具），为了便于这类应用的授权，语雀提供了一种非 Web 应用的授权流程。</p><blockquote style="padding-left:1em;"><p><span style="color:#F5222D;">注意：此流程需要将 </span><span style="color:#F5222D;"><strong>client_secret</strong></span><span style="color:#F5222D;"> 下发到客户端中，有一定秘钥泄露的风险。</span></p></blockquote> <h4 id="流程-2"><a href="#流程-2" class="header-anchor">#</a> 流程</h4> <ol start="1"><li>客户端随机生成一个 40 位长度的 code。<br></li><li>将用户重定向到语雀的授权页，参数用 client_secret 加签。<br></li><li>用户确定授权，应用通过 code 调用语雀接口换取用户的 token。<br></li><li>通过 token 访问语雀开放 API。<br></li></ol> <h4 id="_1-客户端生成-code"><a href="#_1-客户端生成-code" class="header-anchor">#</a> 1. 客户端生成 code</h4> <p>客户端自行生成一个长度为 40 的随机字符串（字母和数字组成），后续流程中需要用到。</p> <h4 id="_2-将用户重定向到语雀授权页"><a href="#_2-将用户重定向到语雀授权页" class="header-anchor">#</a> 2. 将用户重定向到语雀授权页</h4> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token constant">GET</span> https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>yuque<span class="token punctuation">.</span>com<span class="token operator">/</span>oauth2<span class="token operator">/</span>authorize 
</code></pre></div><h5 id="参数-4"><a href="#参数-4" class="header-anchor">#</a> 参数</h5> <table class="lake-table"><colgroup><col width="162"><col width="95"><col width="450"></colgroup><tbody><tr><td><p>参数名</p></td><td><p>类型</p></td><td><p>描述</p></td></tr><tr><td><p><code>client_id</code></p></td><td><p><code>string</code></p></td><td><p>语雀应用分配的 client_id</p></td></tr><tr><td><p><code>code</code></p></td><td><p><code>string</code></p></td><td><p>上一步中生成的 code</p></td></tr><tr><td><p><code>response_type</code></p></td><td><p><code>string</code></p></td><td><p>固定值: <code>code</code></p></td></tr><tr><td><p><code>scope</code></p></td><td><p><code>string</code></p></td><td><p>要求用户授权的 <a href="https://www.yuque.com/yuque/developer/understanding-scopes-for-oauth-apps#opr4j" target="_blank"><span style="color:#096DD9;">权限范围</span></a>，多个权限用逗号分隔</p><p>例如: <code>doc,repo,group:read</code></p></td></tr><tr><td><p><code>timestamp</code></p></td><td><p><code>string</code></p></td><td><p>当前时间的时间戳（毫秒值）</p><p>例如：1530243304828</p></td></tr><tr><td><p><code>sign</code></p></td><td><p><code>string</code></p></td><td><p>签名，签名方式见下面的描述</p></td></tr></tbody></table><p>需要对参数签名语雀才会认为是合法的应用发起的授权请求，签名方式如下：</p><p>所有的参数以字母顺序排序（ <code>client_id</code> , <code>code</code> , <code>response_type</code> , <code>scope</code> , <code>timestamp</code> ），<strong>将所有的参数值 URL encode</strong>，最后用 <code>&amp;</code> 拼接到一起：</p> <div class="language-undefined extra-class"><pre class="language-text"><code>client_id=IDg4dfUS5vaNo05vqrXa&amp;code=2Omo46aDfdssxjpffffptMAbmuj7xu8dBURRsHun&amp;response_type=code&amp;scope=doc%2Crepo×tamp=1530243304828 
</code></pre></div><p>将拼接好的字符串，使用 sha1 加签，秘钥为 client_secret，并对加签后的结果进行 base64 编码拿到字符串，设置到 sign 参数即可。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Node.js 参考代码</span>
<span class="token keyword">function</span> <span class="token function">sign</span><span class="token punctuation">(</span><span class="token parameter">query<span class="token punctuation">,</span> secret</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">const</span> signString <span class="token operator">=</span> <span class="token punctuation">[</span>
   <span class="token string">'client_id'</span><span class="token punctuation">,</span> <span class="token string">'code'</span><span class="token punctuation">,</span> <span class="token string">'response_type'</span><span class="token punctuation">,</span> <span class="token string">'scope'</span><span class="token punctuation">,</span> <span class="token string">'timestamp'</span><span class="token punctuation">,</span>
 <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>query<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'&amp;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> crypto<span class="token punctuation">.</span><span class="token function">createHmac</span><span class="token punctuation">(</span><span class="token string">'sha1'</span><span class="token punctuation">,</span> secret<span class="token punctuation">)</span>
   <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>signString<span class="token punctuation">)</span>
   <span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre></div><h4 id="_3-通过-code-调用语雀接口换取用户的-token"><a href="#_3-通过-code-调用语雀接口换取用户的-token" class="header-anchor">#</a> 3.通过 code 调用语雀接口换取用户的 token</h4> <p>这个流程用户授权完成之后，不会再把 code 通过 URL 返回，客户端可以直接通过第一步中随机生成的 code 原始值调用语雀的接口换取用户的 token，<strong>这一步不需要再传递 client_secret</strong>。</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token constant">POST</span> https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>yuque<span class="token punctuation">.</span>com<span class="token operator">/</span>oauth2<span class="token operator">/</span>token 
</code></pre></div><h5 id="参数-5"><a href="#参数-5" class="header-anchor">#</a> 参数</h5> <table class="lake-table"><colgroup><col width="250"><col width="250"><col width="250"></colgroup><tbody><tr><td><p>参数名</p></td><td><p>类型</p></td><td><p>描述</p></td></tr><tr><td><p>client_id</p></td><td><p>string</p></td><td><p>语雀应用分配的 client_id</p></td></tr><tr><td><p>code</p></td><td><p>string</p></td><td><p>前序流程中获取到的临时授权码</p></td></tr><tr><td><p>grant_type</p></td><td><p>string</p></td><td><p>固定值 <code>client_code</code></p></td></tr></tbody></table> <h5 id="响应-2"><a href="#响应-2" class="header-anchor">#</a> 响应</h5> <p>响应是一个 JSON 格式的字符串，包含用户授权后的 token，该 token 只能访问用户授权范围内的 API。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">{</span> 
 <span class="token string">&quot;access_token&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;am9ic0B5dXF1ZS5jb20=&quot;</span><span class="token punctuation">,</span>
 <span class="token string">&quot;token_type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;bearer&quot;</span><span class="token punctuation">,</span>
 <span class="token string">&quot;scope&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;repo,doc&quot;</span>
<span class="token punctuation">}</span> 
</code></pre></div><p>一般来说，由于用户确认授权后不会回调，所以在将用户重定向到语雀授权页之后就可以开始轮询语雀的授权接口了（请注意轮询间隔时长控制在 3s 左右）。</p> <h4 id="_4-通过-token-来访问语雀的-api-2"><a href="#_4-通过-token-来访问语雀的-api-2" class="header-anchor">#</a> 4. 通过 Token 来访问语雀的 API</h4> <p>后续流程和 OAuth 授权一样，通过 token 即可以授权用户的身份访问 API。</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code>curl <span class="token operator">-</span><span class="token constant">H</span> <span class="token string">'X-Auth-Token: ${token}'</span> https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>yuque<span class="token punctuation">.</span>com<span class="token operator">/</span>api<span class="token operator">/</span>v2<span class="token operator">/</span>user 
</code></pre></div><h4 id="node-js-客户端"><a href="#node-js-客户端" class="header-anchor">#</a> Node.js 客户端</h4> <p><span>Node.js 版本的授权过程已经封装成了一个模块 </span><a href="https://www.npmjs.com/package/yuque-auth" target="_blank">yuque-auth</a><span>，如果应用是 Node.js 编写，可以直接使用，其他语言也可以参考该模块自行实现。</span></p> <h3 id="常见的接口错误"><a href="#常见的接口错误" class="header-anchor">#</a> 常见的接口错误</h3> <h4 id="请求参数错误"><a href="#请求参数错误" class="header-anchor">#</a> 请求参数错误</h4> <p>此错误只在 “非 Web 应用流程<span>”（即在参数中传 ） 中出现</span></p><p>错误接口：POST /oauth2/authorize</p><p>错误原因：</p><ul><li>sign 传了空字符串</li><li>sign 不合法（参数以字母顺序排序（ client_id , code , response_type , scope , timestamp ），将所有的参数值 URL encode，最后用 &amp; 拼接到一起，将拼接好的字符串，使用 sha1 加签，秘钥为 client_secret，并对加签后的结果进行 base64 编码拿到字符串）</li><li>timestamp 传了空字符串</li><li>timestamp 不在现在时间的正负 10 分钟之内</li><li>code 长度不是 40 个字符</li><li>client_id 不正确</li></ul> <h4 id="authorization-code-is-invalid"><a href="#authorization-code-is-invalid" class="header-anchor">#</a> authorization code is invalid</h4> <p>错误接口：POST /oauth2/token</p><p>错误原因：</p><ul><li>code 传了空字符串</li><li>client_id 传了空字符串</li><li>client_id 传了不是自己应用的 client id</li><li>grant_type 传了不匹配的值</li></ul> <h4 id="authorization-client-is-invalid"><a href="#authorization-client-is-invalid" class="header-anchor">#</a> authorization client is invalid</h4> <p>错误接口：<span>POST /oauth2/token</span></p><p><span>错误原因：</span></p><ul><li>应用已经删除</li></ul> <h4 id="grant-type-invalid"><a href="#grant-type-invalid" class="header-anchor">#</a> grant_type invalid</h4> <p>错误接口：<span>POST /oauth2/token</span></p><p><span>错误原因：</span></p><ul><li>参数 grant_type 不是 authorization_code 或 client_code</li></ul><br><br><a target="_blank" href="https://www.yuque.com/yuque/developer/authorizing-oauth-apps" class="yuque-link"><svg viewBox="64 64 896 896" data-icon="yuque" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M854.6 370.6c-9.9-39.4 9.9-102.2 73.4-124.4l-67.9-3.6s-25.7-90-143.6-98c-117.8-8.1-194.9-3-195-3 .1 0 87.4 55.6 52.4 154.7-25.6 52.5-65.8 95.6-108.8 144.7-1.3 1.3-2.5 2.6-3.5 3.7C319.4 605 96 860 96 860c245.9 64.4 410.7-6.3 508.2-91.1 20.5-.2 35.9-.3 46.3-.3 135.8 0 250.6-117.6 245.9-248.4-3.2-89.9-31.9-110.2-41.8-149.6zm-204.1 334c-10.6 0-26.2.1-46.8.3l-23.6.2-17.8 15.5c-47.1 41-104.4 71.5-171.4 87.6-52.5 12.6-110 16.2-172.7 9.6 18-20.5 36.5-41.6 55.4-63.1 92-104.6 173.8-197.5 236.9-268.5l1.4-1.4 1.3-1.5c4.1-4.6 20.6-23.3 24.7-28.1 9.7-11.1 17.3-19.9 24.5-28.6 30.7-36.7 52.2-67.8 69-102.2l1.6-3.3 1.2-3.4c13.7-38.8 15.4-76.9 6.2-112.8 22.5.7 46.5 1.9 71.7 3.6 33.3 2.3 55.5 12.9 71.1 29.2 5.8 6 10.2 12.5 13.4 18.7 1 2 1.7 3.6 2.3 5l5 17.7c-15.7 34.5-19.9 73.3-11.4 107.2 3 11.8 6.9 22.4 12.3 34.4 2.1 4.7 9.5 20.1 11 23.3 10.3 22.7 15.4 43 16.7 78.7 3.3 94.6-82.7 181.9-182 181.9z"></path></svg> 使用语雀查看</a></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/create-oauth-apps.html" class="prev">创建 OAuth 应用</a></span> <span class="next"><a href="/understanding-scopes-for-oauth-apps.html">了解 OAuth 应用的授权范围</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.dc7065eb.js" defer></script><script src="/assets/js/2.aebe52ac.js" defer></script><script src="/assets/js/16.8b34ccdc.js" defer></script>
  </body>
</html>
