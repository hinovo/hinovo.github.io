(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{213:function(t,a,s){"use strict";s.r(a);var e=s(0),n=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"授权-oauth-应用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#授权-oauth-应用"}},[t._v("#")]),t._v(" 授权 OAuth 应用")]),t._v(" "),s("p",[s("span",[t._v("语雀支持标准的 ")]),s("a",{attrs:{href:"https://oauth.net/2/grant-types/authorization-code/",target:"_blank"}},[t._v("OAuth2 authorization code")]),t._v(" 授权模式")]),t._v(" "),s("h3",{attrs:{id:"web-应用流程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#web-应用流程"}},[t._v("#")]),t._v(" Web 应用流程")]),t._v(" "),s("h4",{attrs:{id:"流程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#流程"}},[t._v("#")]),t._v(" 流程")]),t._v(" "),s("ol",{attrs:{start:"1"}},[s("li",[t._v("用户被重定向以请求他们的语雀身份")]),s("li",[t._v("用户被语雀重定向回你的网站")]),s("li",[t._v("你的应用使用用户的 access token 访问 API")])]),t._v(" "),s("h4",{attrs:{id:"时序图"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#时序图"}},[t._v("#")]),t._v(" 时序图")]),t._v(" "),s("img",{staticStyle:{"max-width":"600px"},attrs:{src:"https://cdn.nlark.com/yuque/__puml/ffdb2a50598745d519649c604ed53bd6.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbmF1dG9udW1iZXJcblxuYWN0b3IgXCLnlKjmiLdcIiBhcyBVc2VyXG5wYXJ0aWNpcGFudCBcIuW6lOeUqOWuouaIt-err1wiIGFzIEFwcENsaWVudFxucGFydGljaXBhbnQgXCLlupTnlKjmnI3liqHnq69cIiBhcyBBcHBTZXJ2ZXJcbnBhcnRpY2lwYW50IFwi6K-t6ZuA5o6I5p2D5pyN5YqhXCIgYXMgQXV0aFNlcnZlciAjb3JhbmdlXG5wYXJ0aWNpcGFudCBcIuivrembgOi1hOa6kOacjeWKoVwiIGFzIFJlc291cmNlU2VydmVyICNvcmFuZ2VcblxuYWN0aXZhdGUgVXNlclxuXG5Vc2VyIC0-IEFwcENsaWVudDog55So5oi36K6_6Zeu5bqU55SoXG5hY3RpdmF0ZSBBcHBDbGllbnRcbkFwcENsaWVudCAtPiBBcHBDbGllbnQ6IOmAieaLqeivrembgOeZu-W9lVxuXG5BcHBDbGllbnQgLT4gQXV0aFNlcnZlcjog5bCG55So5oi36YeN5a6a5ZCR5Yiw5o6I5p2D6aG1IEdFVCBodHRwczovL3d3dy55dXF1ZS5jb20vb2F1dGgyL2F1dGhvcml6ZVxubm90ZSByaWdodCBvZiBBcHBDbGllbnQ6IOW4puS4iiBjbGllbnRfaWTjgIFzY29wZeOAgXJlZGlyZWN0X3VyaeOAgXN0YXRl44CBcmVzcG9uc2VfdHlwZSDlj4LmlbBcbmFjdGl2YXRlIEF1dGhTZXJ2ZXJcblxuQXV0aFNlcnZlciAtPiBBdXRoU2VydmVyOiDmjojmnYPmiJDlip_lkI7lsIbkvJrph43lrprlkJHliLDmjIflrprnmoTlm57osIPlnLDlnYBcbm5vdGUgcmlnaHQgb2YgQXV0aFNlcnZlcjog5Lmf5bCx5piv6K-35rGC5bim5LiK55qEIHJlZGlyZWN0X3VyaSwg6YeN5a6a5ZCR5LiA6Iis5piv5bqU55So5pyN5Yqh56uv5o6l5Y-jXG5cbkF1dGhTZXJ2ZXIgLT4gQXBwU2VydmVyOiDph43lrprlkJHlm57osIPvvIzov5Tlm54gc3RhdGUg5ZKMIGNvZGUgXG5hY3RpdmF0ZSBBcHBTZXJ2ZXJcblxuQXBwU2VydmVyIC0-IEF1dGhTZXJ2ZXI6IOmAmui_hyBjb2RlIOaNouWPlueUqOaItyB0b2tlbiBQT1NUIGh0dHBzOi8vd3d3Lnl1cXVlLmNvbS9vYXV0aDIvdG9rZW5cbm5vdGUgcmlnaHQgb2YgQXBwU2VydmVyOiDov5nph4zpnIDopoHluKbkuIogY2xpZW50X2lk44CBY2xpZW50X3NlY3JldOOAgWNvZGXjgIFncmFudF90eXBlXG5cblxuQXV0aFNlcnZlciAtPiBBcHBTZXJ2ZXI6IOi_lOWbnueUqOaItyB0b2tlbiDkv6Hmga9cbm5vdGUgcmlnaHQgb2YgQXBwU2VydmVyOiDljIXlkKsgYWNjZXNzX3Rva2Vu44CBdG9rZW5fdHlwZeOAgXNjb3BlXG5kZWFjdGl2YXRlIEF1dGhTZXJ2ZXJcblxuQXBwU2VydmVyIC0-IEFwcENsaWVudDog6L-U5Zue5o6I5p2D5oiQ5YqfXG5kZWFjdGl2YXRlIEFwcFNlcnZlclxuQXBwQ2xpZW50IC0-IFJlc291cmNlU2VydmVyOiDlrqLmiLfnq6_lj5HotbfnlKjmiLfln7rmnKzkv6Hmga_otYTmupDor7fmsYIgY3VybCAtSCAnWC1BdXRoLVRva2VuOiAke3Rva2VufScgaHR0cHM6Ly9sYXJrLmFsaXBheS5jb20vYXBpL3YyL3VzZXJcbmFjdGl2YXRlIFJlc291cmNlU2VydmVyXG5SZXNvdXJjZVNlcnZlciAtPiBBcHBDbGllbnQ6IOi_lOWbnueUqOaIt-S_oeaBr1xuZGVhY3RpdmF0ZSBSZXNvdXJjZVNlcnZlclxuQXBwQ2xpZW50IC0-IFVzZXI6IOWIt-aWsOmhtemdou-8jOaYvuekuueUqOaIt-S_oeaBr1xuXG5Vc2VyIC0-IEFwcENsaWVudDog55So5oi35Y-R6LW36K-35rGC6K-t6ZuA6LWE5rqQ55qE5Yqo5L2cXG5BcHBDbGllbnQgLT4gUmVzb3VyY2VTZXJ2ZXI6IOWuouaIt-err-WPkei1t-i1hOa6kOivt-axglxuYWN0aXZhdGUgUmVzb3VyY2VTZXJ2ZXJcblJlc291cmNlU2VydmVyIC0-IEFwcENsaWVudDog6L-U5Zue6LWE5rqQXG5kZWFjdGl2YXRlIFJlc291cmNlU2VydmVyXG5BcHBDbGllbnQgLT4gVXNlcjog5pi-56S66LWE5rqQXG5cbkBlbmR1bWwiLCJ1cmwiOiJodHRwczovL2Nkbi5ubGFyay5jb20veXVxdWUvX19wdW1sL2ZmZGIyYTUwNTk4NzQ1ZDUxOTY0OWM2MDRlZDUzYmQ2LnN2ZyIsInR5cGUiOiJwdW1sIiwiaWQiOiJjcTR3MSIsImNhcmQiOiJkaWFncmFtIn0="}}),t._v(" "),s("h4",{attrs:{id:"_1-将用户重定向到语雀授权页"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-将用户重定向到语雀授权页"}},[t._v("#")]),t._v(" 1. 将用户重定向到语雀授权页")]),t._v(" "),s("div",{staticClass:"language-ruby extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ruby"}},[s("code",[s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("GET")]),t._v(" https"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("www"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("yuque"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("oauth2"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("authorize \n")])])]),s("h5",{attrs:{id:"参数"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参数"}},[t._v("#")]),t._v(" 参数")]),t._v(" "),s("table",{staticClass:"lake-table"},[s("colgroup",[s("col",{attrs:{width:"161"}}),s("col",{attrs:{width:"93"}}),s("col",{attrs:{width:"460"}})]),s("tbody",[s("tr",[s("td",[s("p",[t._v("参数名")])]),s("td",[s("p",[t._v("类型")])]),s("td",[s("p",[t._v("描述")])])]),s("tr",[s("td",[s("p",[s("code",[t._v("client_id")])])]),s("td",[s("p",[s("code",[t._v("string")])])]),s("td",[s("p",[t._v("语雀应用分配的 client_id")])])]),s("tr",[s("td",[s("p",[s("code",[t._v("scope")])])]),s("td",[s("p",[s("code",[t._v("string")])])]),s("td",[s("p",[t._v("要求用户授权的 "),s("a",{attrs:{href:"https://www.yuque.com/yuque/developer/understanding-scopes-for-oauth-apps#opr4j",target:"_blank"}},[t._v("权限范围")]),t._v("，多个权限用逗号分隔，例如: "),s("code",[t._v("doc,repo,group:read")])])])]),s("tr",[s("td",[s("p",[s("code",[t._v("redirect_uri")])])]),s("td",[s("p",[s("code",[t._v("string")])])]),s("td",[s("p",[t._v("重定向地址，授权完成后会跳转到这个路径，并带上临时授权 code")])])]),s("tr",[s("td",[s("p",[s("code",[t._v("state")])])]),s("td",[s("p",[s("code",[t._v("string")])])]),s("td",[s("p",[t._v("OAuth 规范中的 state，会透传到回调的 redirect_uri 参数")])])]),s("tr",[s("td",[s("p",[s("code",[t._v("response_type")])])]),s("td",[s("p",[s("code",[t._v("string")])])]),s("td",[s("p",[t._v("固定值: "),s("code",[t._v("code")])])])])])]),t._v(" "),s("h4",{attrs:{id:"_2-用户被重定向回应用回调地址"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-用户被重定向回应用回调地址"}},[t._v("#")]),t._v(" 2. 用户被重定向回应用回调地址")]),t._v(" "),s("p",[t._v("用户确认授权后，将被重定向到应用指定的回调地址，并附带 "),s("code",[t._v("state")]),t._v(" 和 "),s("code",[t._v("code")]),t._v(" 参数。")]),t._v(" "),s("h5",{attrs:{id:"参数-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参数-2"}},[t._v("#")]),t._v(" 参数")]),t._v(" "),s("table",{staticClass:"lake-table"},[s("colgroup",[s("col",{attrs:{width:"170"}}),s("col",{attrs:{width:"94"}}),s("col",{attrs:{width:"454"}})]),s("tbody",[s("tr",[s("td",[s("p",[t._v("参数名")])]),s("td",[s("p",[t._v("类型")])]),s("td",[s("p",[t._v("描述")])])]),s("tr",[s("td",[s("p",[s("code",[t._v("code")])])]),s("td",[s("p",[s("code",[t._v("string")])])]),s("td",[s("p",[t._v("用户的临时授权码，用于后续流程中调用语雀接口，换取用户的 access_token")])])]),s("tr",[s("td",[s("p",[s("code",[t._v("state")])])]),s("td",[s("p",[s("code",[t._v("string")])])]),s("td",[s("p",[t._v("上一步流程中的 state 参数透传")])])])])]),t._v(" "),s("h4",{attrs:{id:"_3-通过-code-换取用户-token"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-通过-code-换取用户-token"}},[t._v("#")]),t._v(" 3. 通过 code 换取用户 token")]),t._v(" "),s("div",{staticClass:"language-ruby extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ruby"}},[s("code",[s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("POST")]),t._v(" https"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("www"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("yuque"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("oauth2"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("token \n")])])]),s("h5",{attrs:{id:"参数-3"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参数-3"}},[t._v("#")]),t._v(" 参数")]),t._v(" "),s("table",{staticClass:"lake-table"},[s("colgroup",[s("col",{attrs:{width:"181"}}),s("col",{attrs:{width:"99"}}),s("col",{attrs:{width:"435"}})]),s("tbody",[s("tr",[s("td",[s("p",[t._v("参数名")])]),s("td",[s("p",[t._v("类型")])]),s("td",[s("p",[t._v("描述")])])]),s("tr",[s("td",[s("p",[s("code",[t._v("client_id")])])]),s("td",[s("p",[s("code",[t._v("string")])])]),s("td",[s("p",[t._v("语雀应用分配的 client_id")])])]),s("tr",[s("td",[s("p",[s("code",[t._v("client_secret")])])]),s("td",[s("p",[s("code",[t._v("string")])])]),s("td",[s("p",[t._v("语雀应用分配的 client_secret")])])]),s("tr",[s("td",[s("p",[s("code",[t._v("code")])])]),s("td",[s("p",[s("code",[t._v("string")])])]),s("td",[s("p",[t._v("前序流程中获取到的临时授权码")])])]),s("tr",[s("td",[s("p",[s("code",[t._v("grant_type")])])]),s("td",[s("p",[s("code",[t._v("string")])])]),s("td",[s("p",[t._v("固定值 "),s("code",[t._v("authorization_code")])])])])])]),t._v(" "),s("h5",{attrs:{id:"响应"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#响应"}},[t._v("#")]),t._v(" 响应")]),t._v(" "),s("p",[t._v("响应是一个 JSON 格式的字符串，包含用户授权后的 token，该 token 只能访问用户授权范围内的 API。")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" \n "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"access_token"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"am9ic0B5dXF1ZS5jb20="')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"token_type"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"bearer"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"scope"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"repo,doc"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" \n")])])]),s("h4",{attrs:{id:"_4-通过-token-来访问语雀的-api"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-通过-token-来访问语雀的-api"}},[t._v("#")]),t._v(" 4. 通过 token 来访问语雀的 API")]),t._v(" "),s("div",{staticClass:"language-ruby extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ruby"}},[s("code",[t._v("curl "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("H")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'X-Auth-Token: ${token}'")]),t._v(" https"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("www"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("yuque"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("api"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("v2"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("user \n")])])]),s("h3",{attrs:{id:"非-web-应用流程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#非-web-应用流程"}},[t._v("#")]),t._v(" 非 Web 应用流程")]),t._v(" "),s("p",[t._v("有些应用可能并没有服务端支持，而是一个纯客户端应用（浏览器插件、命令行工具），为了便于这类应用的授权，语雀提供了一种非 Web 应用的授权流程。")]),s("blockquote",{staticStyle:{"padding-left":"1em"}},[s("p",[s("span",{staticStyle:{color:"#F5222D"}},[t._v("注意：此流程需要将 ")]),s("span",{staticStyle:{color:"#F5222D"}},[s("strong",[t._v("client_secret")])]),s("span",{staticStyle:{color:"#F5222D"}},[t._v(" 下发到客户端中，有一定秘钥泄露的风险。")])])]),t._v(" "),s("h4",{attrs:{id:"流程-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#流程-2"}},[t._v("#")]),t._v(" 流程")]),t._v(" "),s("ol",{attrs:{start:"1"}},[s("li",[t._v("客户端随机生成一个 40 位长度的 code。"),s("br")]),s("li",[t._v("将用户重定向到语雀的授权页，参数用 client_secret 加签。"),s("br")]),s("li",[t._v("用户确定授权，应用通过 code 调用语雀接口换取用户的 token。"),s("br")]),s("li",[t._v("通过 token 访问语雀开放 API。"),s("br")])]),t._v(" "),s("h4",{attrs:{id:"_1-客户端生成-code"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-客户端生成-code"}},[t._v("#")]),t._v(" 1. 客户端生成 code")]),t._v(" "),s("p",[t._v("客户端自行生成一个长度为 40 的随机字符串（字母和数字组成），后续流程中需要用到。")]),t._v(" "),s("h4",{attrs:{id:"_2-将用户重定向到语雀授权页"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-将用户重定向到语雀授权页"}},[t._v("#")]),t._v(" 2. 将用户重定向到语雀授权页")]),t._v(" "),s("div",{staticClass:"language-ruby extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ruby"}},[s("code",[s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("GET")]),t._v(" https"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("www"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("yuque"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("oauth2"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("authorize \n")])])]),s("h5",{attrs:{id:"参数-4"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参数-4"}},[t._v("#")]),t._v(" 参数")]),t._v(" "),s("table",{staticClass:"lake-table"},[s("colgroup",[s("col",{attrs:{width:"162"}}),s("col",{attrs:{width:"95"}}),s("col",{attrs:{width:"450"}})]),s("tbody",[s("tr",[s("td",[s("p",[t._v("参数名")])]),s("td",[s("p",[t._v("类型")])]),s("td",[s("p",[t._v("描述")])])]),s("tr",[s("td",[s("p",[s("code",[t._v("client_id")])])]),s("td",[s("p",[s("code",[t._v("string")])])]),s("td",[s("p",[t._v("语雀应用分配的 client_id")])])]),s("tr",[s("td",[s("p",[s("code",[t._v("code")])])]),s("td",[s("p",[s("code",[t._v("string")])])]),s("td",[s("p",[t._v("上一步中生成的 code")])])]),s("tr",[s("td",[s("p",[s("code",[t._v("response_type")])])]),s("td",[s("p",[s("code",[t._v("string")])])]),s("td",[s("p",[t._v("固定值: "),s("code",[t._v("code")])])])]),s("tr",[s("td",[s("p",[s("code",[t._v("scope")])])]),s("td",[s("p",[s("code",[t._v("string")])])]),s("td",[s("p",[t._v("要求用户授权的 "),s("a",{attrs:{href:"https://www.yuque.com/yuque/developer/understanding-scopes-for-oauth-apps#opr4j",target:"_blank"}},[s("span",{staticStyle:{color:"#096DD9"}},[t._v("权限范围")])]),t._v("，多个权限用逗号分隔")]),s("p",[t._v("例如: "),s("code",[t._v("doc,repo,group:read")])])])]),s("tr",[s("td",[s("p",[s("code",[t._v("timestamp")])])]),s("td",[s("p",[s("code",[t._v("string")])])]),s("td",[s("p",[t._v("当前时间的时间戳（毫秒值）")]),s("p",[t._v("例如：1530243304828")])])]),s("tr",[s("td",[s("p",[s("code",[t._v("sign")])])]),s("td",[s("p",[s("code",[t._v("string")])])]),s("td",[s("p",[t._v("签名，签名方式见下面的描述")])])])])]),s("p",[t._v("需要对参数签名语雀才会认为是合法的应用发起的授权请求，签名方式如下：")]),s("p",[t._v("所有的参数以字母顺序排序（ "),s("code",[t._v("client_id")]),t._v(" , "),s("code",[t._v("code")]),t._v(" , "),s("code",[t._v("response_type")]),t._v(" , "),s("code",[t._v("scope")]),t._v(" , "),s("code",[t._v("timestamp")]),t._v(" ），"),s("strong",[t._v("将所有的参数值 URL encode")]),t._v("，最后用 "),s("code",[t._v("&")]),t._v(" 拼接到一起：")]),t._v(" "),s("div",{staticClass:"language-undefined extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("client_id=IDg4dfUS5vaNo05vqrXa&code=2Omo46aDfdssxjpffffptMAbmuj7xu8dBURRsHun&response_type=code&scope=doc%2Crepo×tamp=1530243304828 \n")])])]),s("p",[t._v("将拼接好的字符串，使用 sha1 加签，秘钥为 client_secret，并对加签后的结果进行 base64 编码拿到字符串，设置到 sign 参数即可。")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Node.js 参考代码")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sign")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("query"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" secret")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" signString "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'client_id'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'code'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'response_type'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'scope'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'timestamp'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("map")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("key")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("key"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("encodeURIComponent")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("query"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("join")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'&'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" crypto"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createHmac")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'sha1'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" secret"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("update")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("signString"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("digest")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("toString")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'base64'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" \n")])])]),s("h4",{attrs:{id:"_3-通过-code-调用语雀接口换取用户的-token"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-通过-code-调用语雀接口换取用户的-token"}},[t._v("#")]),t._v(" 3.通过 code 调用语雀接口换取用户的 token")]),t._v(" "),s("p",[t._v("这个流程用户授权完成之后，不会再把 code 通过 URL 返回，客户端可以直接通过第一步中随机生成的 code 原始值调用语雀的接口换取用户的 token，"),s("strong",[t._v("这一步不需要再传递 client_secret")]),t._v("。")]),t._v(" "),s("div",{staticClass:"language-ruby extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ruby"}},[s("code",[s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("POST")]),t._v(" https"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("www"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("yuque"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("oauth2"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("token \n")])])]),s("h5",{attrs:{id:"参数-5"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参数-5"}},[t._v("#")]),t._v(" 参数")]),t._v(" "),s("table",{staticClass:"lake-table"},[s("colgroup",[s("col",{attrs:{width:"250"}}),s("col",{attrs:{width:"250"}}),s("col",{attrs:{width:"250"}})]),s("tbody",[s("tr",[s("td",[s("p",[t._v("参数名")])]),s("td",[s("p",[t._v("类型")])]),s("td",[s("p",[t._v("描述")])])]),s("tr",[s("td",[s("p",[t._v("client_id")])]),s("td",[s("p",[t._v("string")])]),s("td",[s("p",[t._v("语雀应用分配的 client_id")])])]),s("tr",[s("td",[s("p",[t._v("code")])]),s("td",[s("p",[t._v("string")])]),s("td",[s("p",[t._v("前序流程中获取到的临时授权码")])])]),s("tr",[s("td",[s("p",[t._v("grant_type")])]),s("td",[s("p",[t._v("string")])]),s("td",[s("p",[t._v("固定值 "),s("code",[t._v("client_code")])])])])])]),t._v(" "),s("h5",{attrs:{id:"响应-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#响应-2"}},[t._v("#")]),t._v(" 响应")]),t._v(" "),s("p",[t._v("响应是一个 JSON 格式的字符串，包含用户授权后的 token，该 token 只能访问用户授权范围内的 API。")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" \n "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"access_token"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"am9ic0B5dXF1ZS5jb20="')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"token_type"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"bearer"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"scope"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"repo,doc"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" \n")])])]),s("p",[t._v("一般来说，由于用户确认授权后不会回调，所以在将用户重定向到语雀授权页之后就可以开始轮询语雀的授权接口了（请注意轮询间隔时长控制在 3s 左右）。")]),t._v(" "),s("h4",{attrs:{id:"_4-通过-token-来访问语雀的-api-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-通过-token-来访问语雀的-api-2"}},[t._v("#")]),t._v(" 4. 通过 Token 来访问语雀的 API")]),t._v(" "),s("p",[t._v("后续流程和 OAuth 授权一样，通过 token 即可以授权用户的身份访问 API。")]),t._v(" "),s("div",{staticClass:"language-ruby extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ruby"}},[s("code",[t._v("curl "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("H")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'X-Auth-Token: ${token}'")]),t._v(" https"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("www"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("yuque"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("api"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("v2"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("user \n")])])]),s("h4",{attrs:{id:"node-js-客户端"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#node-js-客户端"}},[t._v("#")]),t._v(" Node.js 客户端")]),t._v(" "),s("p",[s("span",[t._v("Node.js 版本的授权过程已经封装成了一个模块 ")]),s("a",{attrs:{href:"https://www.npmjs.com/package/yuque-auth",target:"_blank"}},[t._v("yuque-auth")]),s("span",[t._v("，如果应用是 Node.js 编写，可以直接使用，其他语言也可以参考该模块自行实现。")])]),t._v(" "),s("h3",{attrs:{id:"常见的接口错误"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#常见的接口错误"}},[t._v("#")]),t._v(" 常见的接口错误")]),t._v(" "),s("h4",{attrs:{id:"请求参数错误"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#请求参数错误"}},[t._v("#")]),t._v(" 请求参数错误")]),t._v(" "),s("p",[t._v("此错误只在 “非 Web 应用流程"),s("span",[t._v("”（即在参数中传 ） 中出现")])]),s("p",[t._v("错误接口：POST /oauth2/authorize")]),s("p",[t._v("错误原因：")]),s("ul",[s("li",[t._v("sign 传了空字符串")]),s("li",[t._v("sign 不合法（参数以字母顺序排序（ client_id , code , response_type , scope , timestamp ），将所有的参数值 URL encode，最后用 & 拼接到一起，将拼接好的字符串，使用 sha1 加签，秘钥为 client_secret，并对加签后的结果进行 base64 编码拿到字符串）")]),s("li",[t._v("timestamp 传了空字符串")]),s("li",[t._v("timestamp 不在现在时间的正负 10 分钟之内")]),s("li",[t._v("code 长度不是 40 个字符")]),s("li",[t._v("client_id 不正确")])]),t._v(" "),s("h4",{attrs:{id:"authorization-code-is-invalid"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#authorization-code-is-invalid"}},[t._v("#")]),t._v(" authorization code is invalid")]),t._v(" "),s("p",[t._v("错误接口：POST /oauth2/token")]),s("p",[t._v("错误原因：")]),s("ul",[s("li",[t._v("code 传了空字符串")]),s("li",[t._v("client_id 传了空字符串")]),s("li",[t._v("client_id 传了不是自己应用的 client id")]),s("li",[t._v("grant_type 传了不匹配的值")])]),t._v(" "),s("h4",{attrs:{id:"authorization-client-is-invalid"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#authorization-client-is-invalid"}},[t._v("#")]),t._v(" authorization client is invalid")]),t._v(" "),s("p",[t._v("错误接口："),s("span",[t._v("POST /oauth2/token")])]),s("p",[s("span",[t._v("错误原因：")])]),s("ul",[s("li",[t._v("应用已经删除")])]),t._v(" "),s("h4",{attrs:{id:"grant-type-invalid"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#grant-type-invalid"}},[t._v("#")]),t._v(" grant_type invalid")]),t._v(" "),s("p",[t._v("错误接口："),s("span",[t._v("POST /oauth2/token")])]),s("p",[s("span",[t._v("错误原因：")])]),s("ul",[s("li",[t._v("参数 grant_type 不是 authorization_code 或 client_code")])]),s("br"),s("br"),s("a",{staticClass:"yuque-link",attrs:{target:"_blank",href:"https://www.yuque.com/yuque/developer/authorizing-oauth-apps"}},[s("svg",{attrs:{viewBox:"64 64 896 896","data-icon":"yuque",width:"1em",height:"1em",fill:"currentColor","aria-hidden":"true"}},[s("path",{attrs:{d:"M854.6 370.6c-9.9-39.4 9.9-102.2 73.4-124.4l-67.9-3.6s-25.7-90-143.6-98c-117.8-8.1-194.9-3-195-3 .1 0 87.4 55.6 52.4 154.7-25.6 52.5-65.8 95.6-108.8 144.7-1.3 1.3-2.5 2.6-3.5 3.7C319.4 605 96 860 96 860c245.9 64.4 410.7-6.3 508.2-91.1 20.5-.2 35.9-.3 46.3-.3 135.8 0 250.6-117.6 245.9-248.4-3.2-89.9-31.9-110.2-41.8-149.6zm-204.1 334c-10.6 0-26.2.1-46.8.3l-23.6.2-17.8 15.5c-47.1 41-104.4 71.5-171.4 87.6-52.5 12.6-110 16.2-172.7 9.6 18-20.5 36.5-41.6 55.4-63.1 92-104.6 173.8-197.5 236.9-268.5l1.4-1.4 1.3-1.5c4.1-4.6 20.6-23.3 24.7-28.1 9.7-11.1 17.3-19.9 24.5-28.6 30.7-36.7 52.2-67.8 69-102.2l1.6-3.3 1.2-3.4c13.7-38.8 15.4-76.9 6.2-112.8 22.5.7 46.5 1.9 71.7 3.6 33.3 2.3 55.5 12.9 71.1 29.2 5.8 6 10.2 12.5 13.4 18.7 1 2 1.7 3.6 2.3 5l5 17.7c-15.7 34.5-19.9 73.3-11.4 107.2 3 11.8 6.9 22.4 12.3 34.4 2.1 4.7 9.5 20.1 11 23.3 10.3 22.7 15.4 43 16.7 78.7 3.3 94.6-82.7 181.9-182 181.9z"}})]),t._v(" 使用语雀查看")])])}),[],!1,null,null,null);a.default=n.exports}}]);